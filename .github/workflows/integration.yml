name: Integration tests

on:
  push:
    branches:
      - trunk
  pull_request:
  workflow_dispatch:

jobs:
  phpunit:
    name: "PHPUnit for ${{ matrix.suite }}"
    continue-on-error: ${{ !matrix.stable }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite:
          # some suites are merged to reduce the number of jobs
          - integration
          - content
          - framework
          - migration
          - devops
    env:
      APP_ENV: test
      DATABASE_URL: mysql://root@127.0.0.1:3306/root
      APP_URL: http://localhost:8000
      APP_SECRET: def00000bb5acb32b54ff8ee130270586eec0e878f7337dc7a837acc31d3ff00f93a56b595448b4b29664847dd51991b3314ff65aeeeb761a133b0ec0e070433bff08e48
      OPENSEARCH_URL: 127.0.0.1:9200
      BLUE_GREEN_DEPLOYMENT: 1
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
      COMPOSER_ROOT_VERSION: 6.6.9999999.9999999-dev

    services:
      elasticsearch:
        image: ${{ matrix.suite == 'integration' && 'opensearchproject/opensearch:1' || 'alpine' }}
        env:
          discovery.type: single-node
          plugins.security.disabled: 'true'
        ports:
          - "9200:9200"

    steps:
      - name: Setup Shopware
        uses: shopware/setup-shopware@feat-add-adminInstall-input
        with:
          shopware-version: ${{ github.ref }}
          shopware-repository: ${{ github.repository }}

      - name: Start Webserver
        run: symfony server:start -d

      - name: Install Shopware
        run: php src/Core/TestBootstrap.php

      - name: Run PHPUnit
        if: matrix.suite != 'unit'
        run: php -d memory_limit=-1 vendor/bin/phpunit --testsuite "${{ matrix.suite }}"
  
  win-checkout:
    runs-on: windows-latest
    name: "Windows check"

    steps:
      - name: Support longpaths
        run: git config --system core.longpaths true

      - name: Clone platform
        uses: actions/checkout@v4