name: Storefront checks and tests

on:
  push:
    branches:
      - trunk
    paths:
      - src/Storefront/Resources/app/storefront/**/*
  pull_request:
    paths:
      - src/Storefront/Resources/app/storefront/**/*
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    env:
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
      COMPOSER_ROOT_VERSION: 6.6.9999999.9999999-dev

    steps:
      - name: Setup Shopware
        uses: shopware/setup-shopware@feat-add-adminInstall-input
        with:
          installStorefront: true
          shopware-version: ${{ github.ref }}
          shopware-repository: ${{ github.repository }}

      - name: Cache ESLint and Stylelint
        uses: actions/cache@v4
        with:
          path: |
            src/Storefront/Resources/app/storefront/node_modules/.eslintcache
            src/Storefront/Resources/app/storefront/node_modules/.stylelintcache
          key: storefront-lint-${{ runner.os }}

      - name: Check Code
        working-directory: src/Storefront/Resources/app/storefront
        run: |
          npm run lint:js
          npm run lint:scss
  
  jest:
    name: "Jest Storefront"
    runs-on: ubuntu-latest
    env:
      APP_ENV: prod
      DATABASE_URL: mysql://root:root@database:3306/root
      APP_URL: http://localhost:8000
      APP_SECRET: def00000bb5acb32b54ff8ee130270586eec0e878f7337dc7a837acc31d3ff00f93a56b595448b4b29664847dd51991b3314ff65aeeeb761a133b0ec0e070433bff08e48
      OPENSEARCH_URL: elasticsearch:9200
      BLUE_GREEN_DEPLOYMENT: 1
      COMPOSER_ROOT_VERSION: 6.6.9999999.9999999-dev

    steps:
      - name: Setup Shopware
        uses: shopware/setup-shopware@feat-add-adminInstall-input
        with:
          installStorefront: true
          shopware-version: ${{ github.ref }}
          shopware-repository: ${{ github.repository }}

      - name: Run Jest Storefront
        run: npm --prefix src/Storefront/Resources/app/storefront run unit -- --silent
